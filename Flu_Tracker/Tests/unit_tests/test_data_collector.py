import data_collector
import unittest
from unittest.mock import Mock, MagicMock, patch, mock_open


class Data_Collector_Tests(unittest.TestCase):
    def setUp(self):
        self.json_data_mock = {'in_reply_to_user_id_str': None, 'retweeted_status': {'in_reply_to_user_id_str': None, 'extended_entities': {'media': [{'expanded_url': 'http://twitter.com/sample/url', 'indices': [000, 000], 'sizes': {'thumb': {'h': 150, 'w': 150, 'resize': 'crop'}, 'medium': {'h': 337, 'w': 600, 'resize': 'fit'}, 'small': {'h': 191, 'w': 340, 'resize': 'fit'}, 'large': {'h': 350, 'w': 622, 'resize': 'fit'}}, 'type': 'photo', 'display_url': 'pic.twitter.com/AAAAAAAAAA', 'id': 671648379928256513, 'media_url': 'http://pbs.twimg.com/media/CVIspJuXIAE5mRp.png', 'url': 'https://t.co/UFhC84CDeA', 'id_str': '671648379928256513', 'media_url_https': 'https://pbs.twimg.com/media/CVIspJuXIAE5mRp.png'}]}, 'entities': {'symbols': [], 'media': [{'expanded_url': 'http://twitter.com/ESPNagora/status/671648380200857604/photo/1', 'indices': [114, 137], 'sizes': {'thumb': {'h': 150, 'w': 150, 'resize': 'crop'}, 'medium': {'h': 337, 'w': 600, 'resize': 'fit'}, 'small': {'h': 191, 'w': 340, 'resize': 'fit'}, 'large': {'h': 350, 'w': 622, 'resize': 'fit'}}, 'type': 'photo', 'display_url': 'pic.twitter.com/UFhC84CDeA', 'id': 671648379928256513, 'media_url': 'http://pbs.twimg.com/media/CVIspJuXIAE5mRp.png', 'url': 'https://t.co/UFhC84CDeA', 'id_str': '671648379928256513', 'media_url_https': 'https://pbs.twimg.com/media/CVIspJuXIAE5mRp.png'}], 'hashtags': [], 'user_mentions': [], 'urls': [{'display_url': 'es.pn/1QaK2NK', 'url': 'https://t.co/l1wpvFHtLY', 'indices': [90, 113], 'expanded_url': 'http://es.pn/1QaK2NK'}]}, 'id': 671648380200857604, 'is_quote_status': False, 'retweeted': False, 'lang': 'pt', 'place': None, 'geo': None, 'coordinates': None, 'source': '<a href="http://bufferapp.com" rel="nofollow">Buffer</a>', 'truncated': False, 'in_reply_to_screen_name': None, 'user': {'profile_link_color': '5C5C5C', 'profile_image_url_https': 'https://pbs.twimg.com/profile_images/661915093991559169/xEp3E-KJ_normal.jpg', 'url': 'http://espn.uol.com.br', 'id': 51124892, 'profile_sidebar_border_color': 'EB2121', 'notifications': None, 'lang': 'pt', 'profile_text_color': '3B393B', 'geo_enabled': True, 'profile_banner_url': 'http://sample_url', 'default_profile': False, 'profile_sidebar_fill_color': 'EDEAEB', 'default_profile_image': False, 'profile_background_image_url': 'http://pbs.twimg.com/profile_background_images/179196513/TwitterBG1.jpg', 'profile_use_background_image': True, 'id_str': '51124892', 'profile_background_image_url_https': 'https://pbs.twimg.com/profile_background_images/179196513/TwitterBG1.jpg', 'description': 'Perfil oficial da ESPN e do SportsCenter no Brasil.                               Informação é o nosso esporte.', 'profile_background_color': '0C0D0D', 'profile_image_url': 'http://pbs.twimg.com/profile_images/661915093991559169/xEp3E-KJ_normal.jpg', 'listed_count': 3778, 'statuses_count': 249874, 'contributors_enabled': False, 'screen_name': 'ESPNagora', 'following': None, 'name': 'Mundo ESPN', 'location': 'Brazil', 'created_at': 'Fri Jun 26 16:36:10 +0000 2009', 'utc_offset': -7200, 'friends_count': 598, 'time_zone': 'Brasilia', 'protected': False, 'is_translator': False, 'favourites_count': 287, 'verified': True, 'follow_request_sent': None, 'profile_background_tile': False, 'followers_count': 827357}, 'in_reply_to_status_id_str': None, 'filter_level': 'low', 'favorite_count': 19, 'id_str': '671648380200857604', 'favorited': False, 'created_at': 'Tue Dec 01 11:13:47 +0000 2015', 'in_reply_to_status_id': None, 'in_reply_to_user_id': None, 'contributors': None, 'retweet_count': 27, 'text': 'This is a sample tweet', 'possibly_sensitive': False}, 'entities': {'symbols': [], 'media': [{'id': 671648379928256513, 'source_user_id_str': '51124892', 'source_user_id': 51124892, 'expanded_url': 'http://twitter.com/ESPNagora/status/671648380200857604/photo/1', 'type': 'photo', 'url': 'https://t.co/UFhC84CDeA', 'indices': [139, 140], 'sizes': {'thumb': {'h': 150, 'w': 150, 'resize': 'crop'}, 'medium': {'h': 337, 'w': 600, 'resize': 'fit'}, 'small': {'h': 191, 'w': 340, 'resize': 'fit'}, 'large': {'h': 350, 'w': 622, 'resize': 'fit'}}, 'source_status_id_str': '671648380200857604', 'display_url': 'pic.twitter.com/UFhC84CDeA', 'source_status_id': 671648380200857604, 'media_url': 'http://pbs.twimg.com/media/CVIspJuXIAE5mRp.png', 'id_str': '671648379928256513', 'media_url_https': 'https://pbs.twimg.com/media/CVIspJuXIAE5mRp.png'}], 'hashtags': [], 'user_mentions': [{'id': 51124892, 'name': 'Mundo ESPN', 'screen_name': 'ESPNagora', 'id_str': '51124892', 'indices': [3, 13]}], 'urls': [{'display_url': 'es.pn/1QaK2NK', 'url': 'https://t.co/l1wpvFHtLY', 'indices': [105, 128], 'expanded_url': 'http://es.pn/1QaK2NK'}]}, 'id': 671698932779630592, 'is_quote_status': False, 'retweeted': False, 'lang': 'pt', 'place': None, 'geo': None, 'coordinates': None, 'source': '<a href="http://twitter.com" rel="nofollow">Twitter Web Client</a>', 'truncated': False, 'in_reply_to_screen_name': None, 'user': {'profile_link_color': '0084B4', 'profile_image_url_https': 'https://pbs.twimg.com/profile_images/3528642724/8a9e2b45dccf7deb9ddcda6acf7e7be7_normal.jpeg', 'url': None, 'id': 463206532, 'profile_sidebar_border_color': 'FFFFFF', 'notifications': None, 'lang': 'pt', 'profile_text_color': '333333', 'geo_enabled': False, 'profile_banner_url': 'https://pbs.twimg.com/profile_banners/463206532/1443449883', 'default_profile': False, 'profile_sidebar_fill_color': 'DDEEF6', 'default_profile_image': False, 'profile_background_image_url': 'http://pbs.twimg.com/profile_background_images/719540735/bb439ad25262968908757c01b95a245a.jpeg', 'profile_use_background_image': True, 'id_str': '463206532', 'profile_background_image_url_https': 'https://pbs.twimg.com/profile_background_images/719540735/bb439ad25262968908757c01b95a245a.jpeg', 'description': 'Engenheiro. Flamengo. Campeão do mundo. Campeão da Libertadores. Campeão da Copa Mercosul. Deca-campeão Nacional.', 'profile_background_color': 'C0DEED', 'profile_image_url': 'http://pbs.twimg.com/profile_images/3528642724/8a9e2b45dccf7deb9ddcda6acf7e7be7_normal.jpeg', 'listed_count': 4, 'statuses_count': 10285, 'contributors_enabled': False, 'screen_name': 'mm_fla', 'following': None, 'name': 'MARCIO MARIANO', 'location': 'Sorocaba-SP', 'created_at': 'Fri Jan 13 21:07:43 +0000 2012', 'utc_offset': -7200, 'friends_count': 1055, 'time_zone': 'Brasilia', 'protected': False, 'is_translator': False, 'favourites_count': 1500, 'verified': False, 'follow_request_sent': None, 'profile_background_tile': True, 'followers_count': 1472}, 'in_reply_to_status_id_str': None, 'filter_level': 'low', 'extended_entities': {'media': [{'id': 671648379928256513, 'source_user_id_str': '51124892', 'source_user_id': 51124892, 'expanded_url': 'http://twitter.com/ESPNagora/status/671648380200857604/photo/1', 'type': 'photo', 'url': 'https://t.co/UFhC84CDeA', 'indices': [139, 140], 'sizes': {'thumb': {'h': 150, 'w': 150, 'resize': 'crop'}, 'medium': {'h': 337, 'w': 600, 'resize': 'fit'}, 'small': {'h': 191, 'w': 340, 'resize': 'fit'}, 'large': {'h': 350, 'w': 622, 'resize': 'fit'}}, 'source_status_id_str': '671648380200857604', 'display_url': 'pic.twitter.com/UFhC84CDeA', 'source_status_id': 671648380200857604, 'media_url': 'http://pbs.twimg.com/media/CVIspJuXIAE5mRp.png', 'id_str': '671648379928256513', 'media_url_https': 'https://pbs.twimg.com/media/CVIspJuXIAE5mRp.png'}]}, 'favorite_count': 0, 'id_str': '671698932779630592', 'favorited': False, 'created_at': 'Tue Dec 01 14:34:39 +0000 2015', 'in_reply_to_status_id': None, 'in_reply_to_user_id': None, 'contributors': None, 'timestamp_ms': '1448980479794', 'retweet_count': 0, 'text': 'This is a sample tweet', 'possibly_sensitive': False}
        self.valid_location_mock = 'Ireland'
        self.invalid_location_mock = None
        self.valid_text_mock = "this is valid text because it conatins the word flu and no banned words"
        self.invalid_text_mock = "this is invalid because it contains the word shot"
        self.valid_language_mock = 'en'
        self.invalid_language_mock = 'rt'
        self.listener = data_collector.Listener()

    def test_get_location_text_and_user_language_from_data(self):
        loc, text, user_language = self.listener.get_location_text_and_user_language_from_data(self.json_data_mock)
        self.assertEquals(loc,'Sorocaba-SP')
        self.assertEquals(text, 'this is a sample tweet')
        self.assertEquals(user_language, 'pt')

    def test_get_geolocation(self):
        pass

    def test_get_country(self):
        pass
    def test_valid_tweet(self):

        self.assertTrue(self.listener.valid_tweet(self.valid_location_mock, self.valid_text_mock, self.valid_language_mock))
        self.assertFalse(self.listener.valid_tweet(self.valid_location_mock, self.valid_text_mock, self.invalid_language_mock))
        self.assertFalse(self.listener.valid_tweet(self.valid_location_mock, self.invalid_text_mock, self.valid_language_mock))
        self.assertFalse(self.listener.valid_tweet(self.invalid_location_mock, self.valid_text_mock, self.valid_language_mock))

    def test_write(self):
        writer = mock_open()
        with patch('data_collector.open', writer, create=True):
            self.listener.write('test', 'path')
            writer.assert_called_with('path', 'a')
        handle = writer()
        handle.write.assert_called_with('test')


if __name__ == '__main__':
    unittest.main()